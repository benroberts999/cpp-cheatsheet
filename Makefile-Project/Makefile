# ============================================================
# Basic Makefile for the gravitational-waves project
#
# - Explicit source lists (no wildcards)
# - One executable per main()
# - Shared code compiled once and reused
#
# Note: Use actual tabs, _not_ spaces for indenting
# ============================================================

# ------------------------------------------------------------
# Compiler options
# ------------------------------------------------------------

# Compiler
CXX := g++

# Directories (SRC contains c++ (.cpp,.hpp) files;
# BUILD is where temporary compiled objects (.o) will be stored)
SRC   := src
BUILD := build

# Compilation options and flags:
#  - C++17 standard
#  - I (include all in given directory)
#  - Optimisation (O2 or O3)
#  - Warnings (help catch bugs early, and great for learning)
#  - -MMD -MP: auto-generate header dependencies (speed-up recompiles)
CXXFLAGS := -std=c++17 -O2 -Wall -Wextra -Wpedantic -I$(SRC) -MMD -MP

# OpenMP support (used in some parts of the code)
# (+= adds to above list)
CXXFLAGS += -fopenmp

# Libraries to link against (e.g., gsl, lapack)
LDFLAGS := -lgsl -lgslcblas -fopenmp

# ------------------------------------------------------------
# Source files
# ------------------------------------------------------------

# List each source file that contains a main()
# - Each will be compiled into its own executable
# - Often there will only be 1 (or 2, if including unit tests)
# - Don't need to add the overall SRC directory here, 
#    .. but if you use sub-folders, add the relative paths here
MAIN_SRCS := main.cpp tests.cpp

# List all other C++ files that _don't_ have a main() here:
# - don't list header files, just .cpp ones
# - don't list any of the main() files
# - For very small projects, this may be blank
LIB_SRCS := some_functions.cpp

# ------------------------------------------------------------
# Convenience targets
# List these under .PHONY so make always runs them,
# even if they are not considered "out of date"
# ------------------------------------------------------------

.PHONY: clean run

# Remove all build products (this should always be included)
# Allows for complete clean re-compile
# Note: be VERY careful with rm !! there is no recycle bin
clean:
	rm -fv $(EXES)
	rm -fv $(MAIN_OBJS) $(LIB_OBJS) $(DEPS)


# You can add other things here too:
# Optional "extra" command, e.g., running or plotting
# Example, rule that runs the code and produces plots
# It 'depends' on our executable, so if the code has changed, will recompile
run: main
	./main

################################################################
## Nothing below should require editing - same for most projects
################################################################

# --------------------------------------------------------------
# Object files and naming conventions
# --------------------------------------------------------------

# Executable names (linux/mac standard: main.cpp -> main)
EXES := $(MAIN_SRCS:%.cpp=%)

# Also common (especially on windows main.cpp -> main.exe):
# EXES := $(MAIN_SRCS:%.cpp=%.exe)

# Replace .cpp with .o for names of object files
MAIN_OBJS := $(MAIN_SRCS:%.cpp=$(BUILD)/%.o)
LIB_OBJS  := $(LIB_SRCS:%.cpp=$(BUILD)/%.o)

# Dependency files generated by -MMD (one .d for each .o)
DEPS := $(LIB_OBJS:.o=.d) $(MAIN_OBJS:.o=.d)

# ------------------------------------------------------------
# Default target
# ------------------------------------------------------------

# Build everything by default
all: $(EXES)

.DEFAULT_GOAL := all

# --------------------------------------------------------------
# Build rules
# --------------------------------------------------------------

# Ensure build directory exists
$(BUILD):
	mkdir -p $(BUILD)

# Compile each C++ file indevidually (.cpp -> .o)
$(BUILD)/%.o: $(SRC)/%.cpp | $(BUILD)
	$(CXX) $(CXXFLAGS) -c $< -o $@

# Then, link object files into executables
$(EXES): %: $(BUILD)/%.o $(LIB_OBJS)
	$(CXX) -o $@ $^ $(LDFLAGS)

# Include automatically generated dependency files (speed up recompile)
-include $(DEPS)